-- Enhanced Sword Simulator GUI 4.0
-- Improved UI, Commands, and Performance

repeat wait() until game.Players.LocalPlayer

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local load = workspace.load.RemoteEvent

-- Configuration
local CONFIG = {
    multi = 2,
    min = 5500,
    max = 9000,
    speed = 5,
    cooldown = 100,
    timeout = 30,
    killAuraRange = 10,
    walkSpeed = 16,
    jumpPower = 50
}

-- State Variables
local STATE = {
    focused = false,
    equipped = false,
    open = true,
    slowfarm = false,
    fastfarm = false,
    god = false,
    kaura = false,
    autoFarm = false,
    antiKick = false,
    speedHack = false,
    noclip = false,
    infiniteJump = false
}

-- Data Storage
local DATA = {
    permagods = {},
    killlog = {},
    monitor = nil,
    csub = player,
    lastpos = nil,
    lastfeasiblepos = nil,
    pw = 0,
    lpw = 0,
    gain = 0,
    counter = 0,
    counter2 = 0
}

-- UI Themes
local THEMES = {
    {primary = Color3.new(0.7, 0, 0.7), secondary = Color3.new(0, 0, 0)},
    {primary = Color3.new(1, 1, 1), secondary = Color3.new(0, 0, 0)},
    {primary = Color3.new(1, 0, 0), secondary = Color3.new(0, 0, 0)},
    {primary = Color3.new(0, 1, 1), secondary = Color3.new(0, 0, 0)},
    {primary = Color3.new(0.2, 0.8, 1), secondary = Color3.new(0.1, 0.1, 0.2)},
    {primary = Color3.new(1, 0.5, 0), secondary = Color3.new(0.1, 0.1, 0.1)}
}

local currentTheme = 1
local theme = THEMES[currentTheme]

-- Enhanced Commands List
local COMMANDS = {
    {cmd = "kill [plr]", desc = "Kills the target player"},
    {cmd = "god [plr]", desc = "Gods the target player"},
    {cmd = "permagod [plr]", desc = "Permanently gods the player"},
    {cmd = "ungod [plr]", desc = "Ungods and kills the player"},
    {cmd = "heal [plr]", desc = "Heals the target player"},
    {cmd = "dmg [plr]", desc = "Damages the target player"},
    {cmd = "tp [plr]", desc = "Teleports to the player"},
    {cmd = "bring [plr]", desc = "Brings player to you"},
    {cmd = "watch [plr]", desc = "Watches the target player"},
    {cmd = "unwatch", desc = "Returns camera to you"},
    {cmd = "monitor [plr]", desc = "Monitors player's power"},
    {cmd = "unmonitor", desc = "Stops monitoring"},
    {cmd = "speed [num]", desc = "Changes walkspeed"},
    {cmd = "jump [num]", desc = "Changes jump power"},
    {cmd = "drop [num]", desc = "Drops number of swords"},
    {cmd = "trapdrop [num]", desc = "Drops killing swords"},
    {cmd = "load", desc = "Reloads your character"},
    {cmd = "ff", desc = "Toggles fast farming"},
    {cmd = "sf", desc = "Toggles slow farming"},
    {cmd = "stick", desc = "Makes sword invisible"},
    {cmd = "drophats", desc = "Drops all accessories"},
    {cmd = "equip [num]", desc = "Equips tools"},
    {cmd = "fly", desc = "Toggles fly mode"},
    {cmd = "noclip", desc = "Toggles noclip"},
    {cmd = "invisible", desc = "Makes you invisible"},
    {cmd = "visible", desc = "Makes you visible"},
    {cmd = "freeze [plr]", desc = "Freezes target player"},
    {cmd = "unfreeze [plr]", desc = "Unfreezes target player"},
    {cmd = "orbit [plr]", desc = "Orbits around player"},
    {cmd = "unorbit", desc = "Stops orbiting"},
    {cmd = "spin", desc = "Spins your character"},
    {cmd = "unspin", desc = "Stops spinning"},
    {cmd = "antikick", desc = "Toggles anti-kick"},
    {cmd = "serverinfo", desc = "Shows server information"},
    {cmd = "playerinfo [plr]", desc = "Shows player information"},
    {cmd = "clear", desc = "Clears output"},
    {cmd = "rejoin", desc = "Rejoins the server"},
    {cmd = "crash", desc = "Crashes your client"},
    {cmd = "listgods", desc = "Shows god list"}
}

-- Utility Functions
local function createTween(obj, props, time, style)
    time = time or 0.3
    style = style or Enum.EasingStyle.Quart
    return TweenService:Create(obj, TweenInfo.new(time, style), props)
end

local function findPlayer(name)
    if not name or name == "me" then return player end
    if name == "all" then return Players:GetPlayers() end
    if name == "others" then
        local others = {}
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player then table.insert(others, p) end
        end
        return others
    end
    
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name:lower():find(name:lower()) then return p end
    end
    return nil
end

local function output(text, persistent)
    if UI.output.Text == text and not persistent then
        UI.output.Text = ""
        wait()
    end
    UI.output.Text = text
end

local function getSwords()
    local swords = {}
    for _, v in pairs(player.Backpack:GetChildren()) do
        if v:IsA("Tool") then table.insert(swords, v) end
    end
    for _, v in pairs(player.Character:GetChildren()) do
        if v:IsA("Tool") then table.insert(swords, v) end
    end
    return swords
end

local function equipSword()
    local sword = player.Backpack:FindFirstChildOfClass("Tool") or player.Character:FindFirstChildOfClass("Tool")
    if not sword then
        load:FireServer()
        sword = player.Backpack:WaitForChild("sword", 5)
    end
    if sword and sword.Parent == player.Backpack then
        sword.Parent = player.Character
    end
    return sword
end

local function generateSword()
    local sword = player.Backpack:FindFirstChildOfClass("Tool") or player.Character:FindFirstChildOfClass("Tool")
    if not sword then
        load:FireServer()
        sword = player.Backpack:WaitForChild("sword", 5)
    end
    return sword
end

-- UI Creation
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SwordSimGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 220, 0, 300)
    mainFrame.Position = UDim2.new(0, 20, 0.5, -150)
    mainFrame.BackgroundColor3 = theme.secondary
    mainFrame.BorderColor3 = theme.primary
    mainFrame.BorderSizePixel = 2
    mainFrame.Parent = screenGui
    
    -- Add corner rounding
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = theme.primary
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = corner:Clone()
    titleCorner.Parent = titleBar
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -60, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "Sword Sim GUI 4.0"
    title.TextColor3 = theme.secondary
    title.TextSize = 14
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Font = Enum.Font.GothamBold
    title.Parent = titleBar
    
    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseButton"
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -30, 0, 2.5)
    closeBtn.BackgroundColor3 = Color3.new(1, 0.3, 0.3)
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "Ã—"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.TextSize = 18
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = titleBar
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 4)
    closeBtnCorner.Parent = closeBtn
    
    -- Theme Button
    local themeBtn = Instance.new("TextButton")
    themeBtn.Name = "ThemeButton"
    themeBtn.Size = UDim2.new(0, 25, 0, 25)
    themeBtn.Position = UDim2.new(1, -60, 0, 2.5)
    themeBtn.BackgroundColor3 = theme.primary
    themeBtn.BorderColor3 = theme.secondary
    themeBtn.BorderSizePixel = 1
    themeBtn.Text = "ðŸŽ¨"
    themeBtn.TextColor3 = theme.secondary
    themeBtn.TextSize = 12
    themeBtn.Parent = titleBar
    
    local themeBtnCorner = Instance.new("UICorner")
    themeBtnCorner.CornerRadius = UDim.new(0, 4)
    themeBtnCorner.Parent = themeBtn
    
    -- Content Frame
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "ContentFrame"
    contentFrame.Size = UDim2.new(1, -10, 1, -90)
    contentFrame.Position = UDim2.new(0, 5, 0, 35)
    contentFrame.BackgroundTransparency = 1
    contentFrame.BorderSizePixel = 0
    contentFrame.ScrollBarThickness = 6
    contentFrame.ScrollBarImageColor3 = theme.primary
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 500)
    contentFrame.Parent = mainFrame
    
    -- Status Frame
    local statusFrame = Instance.new("Frame")
    statusFrame.Name = "StatusFrame"
    statusFrame.Size = UDim2.new(1, -10, 0, 50)
    statusFrame.Position = UDim2.new(0, 5, 1, -55)
    statusFrame.BackgroundColor3 = theme.secondary
    statusFrame.BorderColor3 = theme.primary
    statusFrame.BorderSizePixel = 1
    statusFrame.Parent = mainFrame
    
    local statusCorner = Instance.new("UICorner")
    statusCorner.CornerRadius = UDim.new(0, 4)
    statusCorner.Parent = statusFrame
    
    -- Output Label
    local output = Instance.new("TextLabel")
    output.Name = "Output"
    output.Size = UDim2.new(1, -10, 1, -10)
    output.Position = UDim2.new(0, 5, 0, 5)
    output.BackgroundTransparency = 1
    output.Text = "Ready"
    output.TextColor3 = theme.primary
    output.TextSize = 12
    output.TextWrapped = true
    output.Font = Enum.Font.Gotham
    output.Parent = statusFrame
    
    return {
        screenGui = screenGui,
        mainFrame = mainFrame,
        titleBar = titleBar,
        closeBtn = closeBtn,
        themeBtn = themeBtn,
        contentFrame = contentFrame,
        statusFrame = statusFrame,
        output = output
    }
end

-- Create Toggle Button Function
local function createToggle(parent, name, position, callback)
    local frame = Instance.new("Frame")
    frame.Name = name .. "Frame"
    frame.Size = UDim2.new(1, -10, 0, 30)
    frame.Position = position
    frame.BackgroundColor3 = theme.secondary
    frame.BorderColor3 = theme.primary
    frame.BorderSizePixel = 1
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -60, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = theme.primary
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Gotham
    label.Parent = frame
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 20)
    toggle.Position = UDim2.new(1, -45, 0.5, -10)
    toggle.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)
    toggle.BorderSizePixel = 0
    toggle.Text = ""
    toggle.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 10)
    toggleCorner.Parent = toggle
    
    local indicator = Instance.new("Frame")
    indicator.Size = UDim2.new(0, 16, 0, 16)
    indicator.Position = UDim2.new(0, 2, 0, 2)
    indicator.BackgroundColor3 = Color3.new(1, 1, 1)
    indicator.BorderSizePixel = 0
    indicator.Parent = toggle
    
    local indicatorCorner = Instance.new("UICorner")
    indicatorCorner.CornerRadius = UDim.new(0, 8)
    indicatorCorner.Parent = indicator
    
    local active = false
    
    toggle.MouseButton1Click:Connect(function()
        active = not active
        
        if active then
            createTween(toggle, {BackgroundColor3 = Color3.new(0.2, 0.8, 0.2)}):Play()
            createTween(indicator, {Position = UDim2.new(0, 22, 0, 2)}):Play()
        else
            createTween(toggle, {BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)}):Play()
            createTween(indicator, {Position = UDim2.new(0, 2, 0, 2)}):Play()
        end
        
        callback(active)
    end)
    
    return frame, toggle, function() return active end
end

-- Enhanced Command Handler
local function runCommand(cmd)
    local args = cmd:lower():split(" ")
    local command = args[1]
    local target = findPlayer(args[2])
    
    -- Single target commands
    if target and type(target) ~= "table" then
        local char = target.Character
        if not char then return output("Player not found or no character") end
        
        local humanoid = char:FindFirstChild("Humanoid")
        local rootPart = char:FindFirstChild("HumanoidRootPart")
        
        if command == "kill" then
            local sword = generateSword()
            if sword then
                while humanoid.Health > 0 do
                    sword.Handle.dmg.RemoteEvent:FireServer(humanoid, player.leaderstats.Power.Value)
                    wait()
                end
                output("Killed " .. target.Name)
            end
            
        elseif command == "god" then
            local sword = generateSword()
            if sword then
                while humanoid.MaxHealth >= humanoid.Health and humanoid.Health > 0 do
                    sword.Handle.dmg.RemoteEvent:FireServer(humanoid, -math.huge)
                    wait()
                end
                output(target.Name .. " is now godded")
            end
            
        elseif command == "heal" then
            local sword = generateSword()
            if sword then
                sword.Handle.dmg.RemoteEvent:FireServer(humanoid, -(humanoid.MaxHealth - humanoid.Health))
                output("Healed " .. target.Name)
            end
            
        elseif command == "dmg" then
            local sword = generateSword()
            if sword then
                sword.Handle.dmg.RemoteEvent:FireServer(humanoid, humanoid.Health / 2)
                output("Damaged " .. target.Name)
            end
            
        elseif command == "tp" then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = rootPart.CFrame
                output("Teleported to " .. target.Name)
            end
            
        elseif command == "bring" then
            if rootPart then
                rootPart.CFrame = player.Character.HumanoidRootPart.CFrame
                output("Brought " .. target.Name)
            end
            
        elseif command == "watch" then
            DATA.csub = target
            output("Watching " .. target.Name)
            
        elseif command == "monitor" then
            DATA.monitor = target
            output("Monitoring " .. target.Name)
            
        elseif command == "freeze" then
            if rootPart then
                rootPart.Anchored = true
                output("Froze " .. target.Name)
            end
            
        elseif command == "unfreeze" then
            if rootPart then
                rootPart.Anchored = false
                output("Unfroze " .. target.Name)
            end
        end
    end
    
    -- Non-target commands
    if command == "speed" then
        local speed = tonumber(args[2]) or 16
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = speed
            output("Speed set to " .. speed)
        end
        
    elseif command == "jump" then
        local jump = tonumber(args[2]) or 50
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.JumpPower = jump
            output("Jump power set to " .. jump)
        end
        
    elseif command == "load" then
        load:FireServer()
        output("Character reloaded")
        
    elseif command == "drop" then
        local amount = tonumber(args[2]) or 1
        for i = 1, amount do
            load:FireServer()
            local sword = player.Backpack:WaitForChild("sword", 5)
            if sword then
                sword.Parent = player.Character
                wait(0.1)
                sword.Parent = workspace
            end
        end
        output("Dropped " .. amount .. " swords")
        
    elseif command == "ff" then
        STATE.fastfarm = not STATE.fastfarm
        output("Fast farm: " .. (STATE.fastfarm and "ON" or "OFF"))
        
    elseif command == "sf" then
        STATE.slowfarm = not STATE.slowfarm
        output("Slow farm: " .. (STATE.slowfarm and "ON" or "OFF"))
        
    elseif command == "unwatch" then
        DATA.csub = player
        output("Camera reset")
        
    elseif command == "unmonitor" then
        DATA.monitor = nil
        output("Monitoring stopped")
        
    elseif command == "clear" then
        output("")
        
    elseif command == "rejoin" then
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
        
    elseif command == "serverinfo" then
        output("Players: " .. #Players:GetPlayers() .. "/12 | Server: " .. game.JobId:sub(1, 8))
        
    elseif command == "invisible" then
        for _, part in pairs(player.Character:GetChildren()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.Transparency = 1
            elseif part:IsA("Accessory") then
                part.Handle.Transparency = 1
            end
        end
        output("Made invisible")
        
    elseif command == "visible" then
        for _, part in pairs(player.Character:GetChildren()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.Transparency = 0
            elseif part:IsA("Accessory") then
                part.Handle.Transparency = 0
            end
        end
        output("Made visible")
    end
end

-- Create Command Bar
local function createCommandBar()
    local commandFrame = Instance.new("Frame")
    commandFrame.Name = "CommandFrame"
    commandFrame.Size = UDim2.new(0, 400, 0, 40)
    commandFrame.Position = UDim2.new(0.5, -200, 0, -80)
    commandFrame.BackgroundColor3 = theme.secondary
    commandFrame.BorderColor3 = theme.primary
    commandFrame.BorderSizePixel = 2
    commandFrame.Visible = false
    commandFrame.Parent = UI.screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = commandFrame
    
    local prefix = Instance.new("TextLabel")
    prefix.Size = UDim2.new(0, 20, 1, 0)
    prefix.BackgroundTransparency = 1
    prefix.Text = ">"
    prefix.TextColor3 = theme.primary
    prefix.TextSize = 16
    prefix.Font = Enum.Font.GothamBold
    prefix.Parent = commandFrame
    
    local textBox = Instance.new("TextBox")
    textBox.Name = "CommandBox"
    textBox.Size = UDim2.new(1, -25, 1, -10)
    textBox.Position = UDim2.new(0, 25, 0, 5)
    textBox.BackgroundTransparency = 1
    textBox.Text = ""
    textBox.PlaceholderText = "Enter command..."
    textBox.TextColor3 = theme.primary
    textBox.PlaceholderColor3 = Color3.new(0.5, 0.5, 0.5)
    textBox.TextSize = 14
    textBox.TextXAlignment = Enum.TextXAlignment.Left
    textBox.Font = Enum.Font.Gotham
    textBox.ClearTextOnFocus = false
    textBox.Parent = commandFrame
    
    -- Command suggestions
    local suggestFrame = Instance.new("ScrollingFrame")
    suggestFrame.Name = "SuggestFrame"
    suggestFrame.Size = UDim2.new(1, 0, 0, 0)
    suggestFrame.Position = UDim2.new(0, 0, 1, 5)
    suggestFrame.BackgroundColor3 = theme.secondary
    suggestFrame.BorderColor3 = theme.primary
    suggestFrame.BorderSizePixel = 1
    suggestFrame.ScrollBarThickness = 4
    suggestFrame.Visible = false
    suggestFrame.Parent = commandFrame
    
    local suggestCorner = corner:Clone()
    suggestCorner.Parent = suggestFrame
    
    textBox.Changed:Connect(function()
        local text = textBox.Text:lower()
        for _, child in pairs(suggestFrame:GetChildren()) do
            if child:IsA("TextButton") then child:Destroy() end
        end
        
        if text ~= "" then
            local matches = {}
            for _, cmdData in pairs(COMMANDS) do
                if cmdData.cmd:lower():find(text) then
                    table.insert(matches, cmdData)
                end
            end
            
            if #matches > 0 then
                suggestFrame.Visible = true
                suggestFrame.Size = UDim2.new(1, 0, 0, math.min(#matches * 25, 100))
                suggestFrame.CanvasSize = UDim2.new(0, 0, 0, #matches * 25)
                
                for i, cmdData in pairs(matches) do
                    local btn = Instance.new("TextButton")
                    btn.Size = UDim2.new(1, -5, 0, 25)
                    btn.Position = UDim2.new(0, 0, 0, (i-1) * 25)
                    btn.BackgroundColor3 = theme.secondary
                    btn.BorderSizePixel = 0
                    btn.Text = cmdData.cmd .. " - " .. cmdData.desc
                    btn.TextColor3 = theme.primary
                    btn.TextSize = 10
                    btn.TextXAlignment = Enum.TextXAlignment.Left
                    btn.Font = Enum.Font.Gotham
                    btn.Parent = suggestFrame
                    
                    btn.MouseEnter:Connect(function()
                        btn.BackgroundColor3 = theme.primary
                        btn.TextColor3 = theme.secondary
                    end)
                    
                    btn.MouseLeave:Connect(function()
                        btn.BackgroundColor3 = theme.secondary
                        btn.TextColor3 = theme.primary
                    end)
                    
                    btn.MouseButton1Click:Connect(function()
                        textBox.Text = cmdData.cmd:split(" ")[1]
                        suggestFrame.Visible = false
                    end)
                end
            else
                suggestFrame.Visible = false
            end
        else
            suggestFrame.Visible = false
        end
    end)
    
    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed and textBox.Text ~= "" then
            runCommand(textBox.Text)
        end
        textBox.Text = ""
        suggestFrame.Visible = false
        createTween(commandFrame, {Position = UDim2.new(0.5, -200, 0, -80)}):Play()
        wait(0.3)
        commandFrame.Visible = false
    end)
    
    return commandFrame, textBox
end

-- Initialize UI
UI = createUI()
local commandFrame, commandBox = createCommandBar()

-- Create Toggles
local yPos = 0
local toggleSpacing = 35

createToggle(UI.contentFrame, "Fast Farm", UDim2.new(0, 0, 0, yPos), function(active)
    STATE.fastfarm = active
end)
yPos = yPos + toggleSpacing

createToggle(UI.contentFrame, "Slow Farm", UDim2.new(0, 0, 0, yPos), function(active)
    STATE.slowfarm = active
end)
yPos = yPos + toggleSpacing

createToggle(UI.contentFrame, "God Mode", UDim2.new(0, 0, 0, yPos), function(active)
    STATE.god = active
    if active then
        if player.Character and player.Character:FindFirstChild("pvp") then
            player.Character.pvp:Destroy()
        end
    else
        load:FireServer()
    end
end)
yPos = yPos + toggleSpacing

createToggle(UI.contentFrame, "Kill Aura", UDim2.new(0, 0, 0, yPos), function(active)
    STATE.kaura = active
end)
yPos = yPos + toggleSpacing

createToggle(UI.contentFrame, "Anti-Kick", UDim2.new(0, 0, 0, yPos), function(active)
    STATE.antiKick = active
end)

-- Event Handlers
UI.closeBtn.MouseButton1Click:Connect(function()
    createTween(UI.mainFrame, {Position = UDim2.new(0, -250, 0.5, -150)}):Play()
    wait(0.3)
    UI.screenGui:Destroy()
    STATE.open = false
end)

UI.themeBtn.MouseButton1Click:Connect(function()
    currentTheme = currentTheme >= #THEMES and 1 or currentTheme + 1
    theme = THEMES[currentTheme]
    
    -- Update all UI colors
    for _, obj in pairs(UI.screenGui:GetDescendants()) do
        if obj:GetAttribute("PrimaryColor") then
            obj.BackgroundColor3 = theme.primary
            if obj:IsA("TextLabel") or obj:IsA("TextButton") then
                obj.TextColor3 = theme.secondary
            end
        elseif obj:GetAttribute("SecondaryColor") then
            obj.BackgroundColor3 = theme.secondary
            if obj:IsA("TextLabel") or obj:IsA("TextButton") then
                obj.TextColor3 = theme.primary
            end
        end
    end
end)

-- Input Handling
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or not STATE.open then return end
    
    if input.KeyCode == Enum.KeyCode.Semicolon then
        commandFrame.Visible = true
        createTween(commandFrame, {Position = UDim2.new(0.5, -200, 0, 50)}):Play()
        wait(0.3)
        commandBox:CaptureFocus()
    end
end)

-- Chat Command Handler
player.Chatted:Connect(function(message)
    if message:sub(1, 1) == ";" then
        runCommand(message:sub(2))
    end
end)

-- Dragging System
local dragging = false
local dragStart = nil
local startPos = nil

UI.titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = UI.mainFrame.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        UI.mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, 
                                         startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Main Loop
RunService.Heartbeat:Connect(function()
    if not STATE.open or not player.Character then return end
    
    local char = player.Character
    local humanoid = char:FindFirstChild("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then return end
    
    -- Update camera subject
    if workspace.CurrentCamera then
        workspace.CurrentCamera.CameraSubject = DATA.csub.Character and DATA.csub.Character.Humanoid or humanoid
    end
    
    -- Update power tracking
    if player.leaderstats and player.leaderstats:FindFirstChild("Power") then
        DATA.pw = player.leaderstats.Power.Value
        DATA.gain = (DATA.pw - DATA.lpw) * 10
        DATA.lpw = DATA.pw
    end
    
    -- Fast Farm
    if STATE.fastfarm then
        local sword = generateSword()
        if sword and sword:FindFirstChild("Handle") and sword.Handle:FindFirstChild("up") then
            local multiplier = CONFIG.multi
            if DATA.gain > CONFIG.min * multiplier and DATA.gain < CONFIG.max * multiplier then
                DATA.counter2 = DATA.counter2 + 1
                if DATA.counter2 > CONFIG.timeout then
                    CONFIG.speed = 7
                    DATA.counter2 = 0
                end
            elseif DATA.gain < CONFIG.min * multiplier then
                DATA.counter = DATA.counter + 1
                if DATA.counter > CONFIG.cooldown then
                    CONFIG.speed = 30
                    DATA.counter = 0
                end
            end
            
            for i = 1, CONFIG.speed do
                sword.Handle.up.RemoteEvent:FireServer()
            end
        end
    end
    
    -- Slow Farm
    if STATE.slowfarm then
        local sword = equipSword()
        if sword and sword:FindFirstChild("Handle") and sword.Handle:FindFirstChild("up") then
            for i = 1, 5 do
                sword.Handle.up.RemoteEvent:FireServer()
            end
        end
    end
    
    -- God Mode
    if STATE.god then
        if char:FindFirstChild("pvp") then
            char.pvp:Destroy()
        end
    end
    
    -- Kill Aura
    if STATE.kaura then
        local sword = equipSword()
        if sword and sword:FindFirstChild("Handle") and sword.Handle:FindFirstChild("dmg") then
            for _, target in pairs(workspace:GetChildren()) do
                if target:FindFirstChild("Humanoid") and target:FindFirstChild("HumanoidRootPart") then
                    local distance = (rootPart.Position - target.HumanoidRootPart.Position).Magnitude
                    if distance <= CONFIG.killAuraRange and target.Name ~= player.Name and target.Humanoid.Health > 0 then
                        sword.Handle.dmg.RemoteEvent:FireServer(target.Humanoid, player.leaderstats.Power.Value)
                    end
                end
            end
        end
    end
    
    -- Permagod System
    for _, target in pairs(DATA.permagods) do
        if target.Character and target.Character:FindFirstChild("Humanoid") then
            local sword = generateSword()
            if sword and sword:FindFirstChild("Handle") and sword.Handle:FindFirstChild("dmg") then
                sword.Handle.dmg.RemoteEvent:FireServer(target.Character.Humanoid, -math.huge)
            end
        end
    end
    
    -- Anti-Kick
    if STATE.antiKick then
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
    
    -- Monitor Display
    if DATA.monitor then
        if DATA.monitor.leaderstats and DATA.monitor.leaderstats:FindFirstChild("Power") then
            output("Monitoring " .. DATA.monitor.Name .. ": " .. DATA.monitor.leaderstats.Power.Value, true)
        end
    end
    
    -- Update status display
    if not DATA.monitor then
        local status = "Ready"
        if STATE.fastfarm then status = status .. " | FF: ON" end
        if STATE.slowfarm then status = status .. " | SF: ON" end
        if STATE.god then status = status .. " | GOD: ON" end
        if STATE.kaura then status = status .. " | KA: ON" end
        
        if player.leaderstats and player.leaderstats:FindFirstChild("Power") then
            status = status .. " | Power: " .. player.leaderstats.Power.Value
        end
        
        if humanoid then
            local healthPercent = math.floor((humanoid.Health / humanoid.MaxHealth) * 100)
            status = status .. " | HP: " .. healthPercent .. "%"
        end
        
        output(status, true)
    end
end)

-- Enhanced Commands Implementation
local function enhancedCommands()
    -- Fly System
    local flying = false
    local flySpeed = 50
    local bodyVelocity, bodyAngularVelocity
    
    local function toggleFly()
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
        
        flying = not flying
        local rootPart = player.Character.HumanoidRootPart
        
        if flying then
            bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            bodyVelocity.Parent = rootPart
            
            bodyAngularVelocity = Instance.new("BodyAngularVelocity")
            bodyAngularVelocity.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bodyAngularVelocity.AngularVelocity = Vector3.new(0, 0, 0)
            bodyAngularVelocity.Parent = rootPart
            
            output("Fly enabled")
            
            -- Fly controls
            local flyConnection
            flyConnection = RunService.Heartbeat:Connect(function()
                if not flying then
                    flyConnection:Disconnect()
                    return
                end
                
                local camera = workspace.CurrentCamera
                local moveVector = Vector3.new(0, 0, 0)
                
                if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                    moveVector = moveVector + camera.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                    moveVector = moveVector - camera.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                    moveVector = moveVector - camera.CFrame.RightVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                    moveVector = moveVector + camera.CFrame.RightVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                    moveVector = moveVector + Vector3.new(0, 1, 0)
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                    moveVector = moveVector - Vector3.new(0, 1, 0)
                end
                
                bodyVelocity.Velocity = moveVector * flySpeed
            end)
        else
            if bodyVelocity then bodyVelocity:Destroy() end
            if bodyAngularVelocity then bodyAngularVelocity:Destroy() end
            output("Fly disabled")
        end
    end
    
    -- Noclip System
    local noclipping = false
    local function toggleNoclip()
        noclipping = not noclipping
        if player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = not noclipping
                end
            end
        end
        output("Noclip: " .. (noclipping and "ON" or "OFF"))
        
        if noclipping then
            local noclipConnection
            noclipConnection = RunService.Stepped:Connect(function()
                if not noclipping then
                    noclipConnection:Disconnect()
                    return
                end
                
                if player.Character then
                    for _, part in pairs(player.Character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        end
    end
    
    -- Orbit System
    local orbiting = false
    local orbitTarget = nil
    local orbitConnection = nil
    
    local function startOrbit(target)
        if orbiting then return end
        
        orbiting = true
        orbitTarget = target
        output("Orbiting " .. target.Name)
        
        local angle = 0
        orbitConnection = RunService.Heartbeat:Connect(function()
            if not orbiting or not orbitTarget or not orbitTarget.Character or not player.Character then
                orbiting = false
                if orbitConnection then orbitConnection:Disconnect() end
                return
            end
            
            local targetPos = orbitTarget.Character:FindFirstChild("HumanoidRootPart")
            local playerRoot = player.Character:FindFirstChild("HumanoidRootPart")
            
            if targetPos and playerRoot then
                angle = angle + 0.1
                local x = math.cos(angle) * 10
                local z = math.sin(angle) * 10
                playerRoot.CFrame = CFrame.new(targetPos.Position + Vector3.new(x, 0, z))
            end
        end)
    end
    
    local function stopOrbit()
        orbiting = false
        orbitTarget = nil
        if orbitConnection then
            orbitConnection:Disconnect()
            orbitConnection = nil
        end
        output("Stopped orbiting")
    end
    
    -- Spinning System
    local spinning = false
    local spinConnection = nil
    
    local function toggleSpin()
        spinning = not spinning
        
        if spinning then
            output("Spinning enabled")
            spinConnection = RunService.Heartbeat:Connect(function()
                if not spinning or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
                    spinning = false
                    if spinConnection then spinConnection:Disconnect() end
                    return
                end
                
                player.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame * CFrame.Angles(0, 0.2, 0)
            end)
        else
            output("Spinning disabled")
            if spinConnection then
                spinConnection:Disconnect()
                spinConnection = nil
            end
        end
    end
    
    -- Add enhanced commands to the command handler
    local originalRunCommand = runCommand
    runCommand = function(cmd)
        local args = cmd:lower():split(" ")
        local command = args[1]
        local target = findPlayer(args[2])
        
        -- Enhanced command handling
        if command == "fly" then
            toggleFly()
        elseif command == "noclip" then
            toggleNoclip()
        elseif command == "orbit" and target and type(target) ~= "table" then
            startOrbit(target)
        elseif command == "unorbit" then
            stopOrbit()
        elseif command == "spin" then
            toggleSpin()
        elseif command == "unspin" then
            spinning = false
        elseif command == "crash" then
            while true do
                wait()
                Instance.new("Part", workspace)
            end
        else
            originalRunCommand(cmd)
        end
    end
end

-- Initialize enhanced commands
enhancedCommands()

-- Startup animation
createTween(UI.mainFrame, {Position = UDim2.new(0, 20, 0.5, -150)}, 0.5, Enum.EasingStyle.Back):Play()

output("Sword Simulator GUI 4.0 loaded! Press ';' to open command bar or type ';help' for commands")

-- Auto-save position
spawn(function()
    while STATE.open do
        wait(5)
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            DATA.lastpos = player.Character.HumanoidRootPart.Position
        end
    end
end)
