-- Enhanced Sword Simulator GUI 5.1 - Fixed Version
-- Complete working script with all features

repeat wait() until game.Players.LocalPlayer

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local load = workspace:WaitForChild("load"):WaitForChild("RemoteEvent")

-- Configuration
local CONFIG = {
    multi = 2,
    min = 5500,
    max = 9000,
    speed = 5,
    cooldown = 100,
    timeout = 30,
    killAuraRange = 10,
    walkSpeed = 16,
    jumpPower = 50,
    flySpeed = 50,
    orbitRadius = 10,
    orbitSpeed = 0.1
}

-- State Variables
local STATE = {
    focused = false,
    equipped = false,
    open = true,
    slowfarm = false,
    fastfarm = false,
    god = false,
    kaura = false,
    antiKick = false,
    flying = false,
    noclip = false,
    spinning = false,
    orbiting = false,
    esp = false,
    infiniteJump = false,
    minimized = false
}

-- Data Storage
local DATA = {
    permagods = {},
    killlog = {},
    monitor = nil,
    csub = player,
    pw = 0,
    lpw = 0,
    gain = 0,
    counter = 0,
    counter2 = 0,
    orbitTarget = nil,
    flyObjects = {},
    espObjects = {},
    notifications = {},
    commandHistory = {},
    historyIndex = 0
}

-- Theme
local theme = {
    background = Color3.fromRGB(25, 25, 25),
    secondary = Color3.fromRGB(35, 35, 35),
    tertiary = Color3.fromRGB(45, 45, 45),
    accent = Color3.fromRGB(88, 101, 242),
    text = Color3.fromRGB(255, 255, 255),
    textDim = Color3.fromRGB(180, 180, 180),
    success = Color3.fromRGB(87, 242, 135),
    danger = Color3.fromRGB(237, 66, 69),
    warning = Color3.fromRGB(255, 193, 7)
}

-- Global UI variable
local UI = {}

-- Utility Functions
local function createTween(obj, props, time, style, direction)
    time = time or 0.3
    style = style or Enum.EasingStyle.Quart
    direction = direction or Enum.EasingDirection.Out
    return TweenService:Create(obj, TweenInfo.new(time, style, direction), props)
end

local function findPlayer(name)
    if not name or name == "" then return nil end
    name = name:lower()
    
    if name == "me" then return player end
    if name == "all" then return Players:GetPlayers() end
    if name == "others" then
        local others = {}
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player then table.insert(others, p) end
        end
        return others
    end
    
    -- Find by partial name
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name:lower():sub(1, #name) == name or p.DisplayName:lower():sub(1, #name) == name then
            return p
        end
    end
    
    return nil
end

local function notify(text, notifType)
    notifType = notifType or "info"
    local colors = {
        info = theme.accent,
        success = theme.success,
        error = theme.danger,
        warning = theme.warning
    }
    
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(0, 250, 0, 50)
    notif.Position = UDim2.new(0.5, -125, 0, -60)
    notif.BackgroundColor3 = theme.secondary
    notif.BorderSizePixel = 0
    notif.Parent = UI.screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = notif
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = colors[notifType]
    stroke.Thickness = 2
    stroke.Parent = notif
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, -20, 1, 0)
    textLabel.Position = UDim2.new(0, 10, 0, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = theme.text
    textLabel.TextSize = 12
    textLabel.TextWrapped = true
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.Font = Enum.Font.Gotham
    textLabel.Parent = notif
    
    -- Animate in
    createTween(notif, {Position = UDim2.new(0.5, -125, 0, 10)}):Play()
    
    -- Auto remove
    task.wait(2.5)
    createTween(notif, {Position = UDim2.new(0.5, -125, 0, -60)}):Play()
    task.wait(0.3)
    notif:Destroy()
end

local function ensureSword()
    local sword = player.Backpack:FindFirstChildOfClass("Tool") or 
                  (player.Character and player.Character:FindFirstChildOfClass("Tool"))
    if not sword then
        load:FireServer()
        wait(0.1)
        sword = player.Backpack:WaitForChild("sword", 3)
    end
    return sword
end

local function getSwordHandle()
    local sword = ensureSword()
    if sword and sword:FindFirstChild("Handle") then
        return sword.Handle
    end
    return nil
end

-- Command Handler
local function runCommand(cmd)
    local args = cmd:lower():split(" ")
    local command = args[1]
    local target = findPlayer(args[2])
    
    -- Combat Commands
    if command == "kill" then
        if args[2] == "all" then
            spawn(function()
                local handle = getSwordHandle()
                if handle and handle:FindFirstChild("dmg") then
                    local killed = 0
                    local players = Players:GetPlayers()
                    
                    notify("Killing all players...", "info")
                    
                    for _, plr in pairs(players) do
                        if plr.Character and plr.Character:FindFirstChild("Humanoid") then
                            local humanoid = plr.Character.Humanoid
                            handle.dmg.RemoteEvent:FireServer(humanoid, math.huge)
                            wait(0.1)
                            
                            if humanoid.Health <= 0 then
                                killed = killed + 1
                            end
                        end
                    end
                    
                    notify("Killed " .. killed .. " players", "success")
                else
                    notify("No sword equipped", "error")
                end
            end)
        elseif target and type(target) == "table" then
            spawn(function()
                local handle = getSwordHandle()
                if handle and handle:FindFirstChild("dmg") then
                    local killed = 0
                    
                    for _, plr in pairs(target) do
                        if plr.Character and plr.Character:FindFirstChild("Humanoid") then
                            handle.dmg.RemoteEvent:FireServer(plr.Character.Humanoid, math.huge)
                            killed = killed + 1
                            wait(0.1)
                        end
                    end
                    
                    notify("Killed " .. killed .. " players", "success")
                else
                    notify("No sword equipped", "error")
                end
            end)
        elseif target then
            spawn(function()
                local char = target.Character
                if char and char:FindFirstChild("Humanoid") then
                    local handle = getSwordHandle()
                    if handle and handle:FindFirstChild("dmg") then
                        handle.dmg.RemoteEvent:FireServer(char.Humanoid, math.huge)
                        notify("Killed " .. target.Name, "success")
                    else
                        notify("No sword equipped", "error")
                    end
                else
                    notify("Target has no character", "error")
                end
            end)
        else
            notify("Player not found", "error")
        end
        return
    end
    
    if command == "god" then
        if target and type(target) == "table" then
            spawn(function()
                local handle = getSwordHandle()
                if handle and handle:FindFirstChild("dmg") then
                    for _, plr in pairs(target) do
                        if plr.Character and plr.Character:FindFirstChild("Humanoid") then
                            for i = 1, 5 do
                                handle.dmg.RemoteEvent:FireServer(plr.Character.Humanoid, -math.huge)
                                wait(0.02)
                            end
                        end
                    end
                    notify("Godded players", "success")
                else
                    notify("No sword equipped", "error")
                end
            end)
        elseif target then
            spawn(function()
                local char = target.Character
                if char and char:FindFirstChild("Humanoid") then
                    local handle = getSwordHandle()
                    if handle and handle:FindFirstChild("dmg") then
                        for i = 1, 5 do
                            handle.dmg.RemoteEvent:FireServer(char.Humanoid, -math.huge)
                            wait(0.02)
                        end
                        notify("Godded " .. target.Name, "success")
                    else
                        notify("No sword equipped", "error")
                    end
                else
                    notify("Target has no character", "error")
                end
            end)
        else
            notify("Player not found", "error")
        end
        return
    end
    
    -- Movement Commands
    if command == "tp" or command == "goto" then
        if target then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and 
               target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame
                notify("Teleported to " .. target.Name, "success")
            else
                notify("Cannot teleport - missing character", "error")
            end
        else
            notify("Player not found", "error")
        end
        return
    end
    
    if command == "bring" then
        if target then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and 
               target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                target.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame
                notify("Brought " .. target.Name, "success")
            else
                notify("Cannot bring - missing character", "error")
            end
        else
            notify("Player not found", "error")
        end
        return
    end
    
    if command == "fly" then
        if not STATE.flying then
            STATE.flying = true
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local rootPart = char.HumanoidRootPart
                
                local bodyVelocity = Instance.new("BodyVelocity")
                bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
                bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                bodyVelocity.Parent = rootPart
                
                local bodyGyro = Instance.new("BodyGyro")
                bodyGyro.MaxTorque = Vector3.new(4000, 4000, 4000)
                bodyGyro.D = 500
                bodyGyro.P = 5000
                bodyGyro.Parent = rootPart
                
                DATA.flyObjects = {bodyVelocity, bodyGyro}
                
                notify("Fly enabled", "success")
                
                spawn(function()
                    while STATE.flying do
                        if not char or not char:FindFirstChild("HumanoidRootPart") or not bodyVelocity.Parent then
                            STATE.flying = false
                            break
                        end
                        
                        local camera = workspace.CurrentCamera
                        local moveVector = Vector3.new(0, 0, 0)
                        
                        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                            moveVector = moveVector + camera.CFrame.LookVector
                        end
                        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                            moveVector = moveVector - camera.CFrame.LookVector
                        end
                        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                            moveVector = moveVector - camera.CFrame.RightVector
                        end
                        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                            moveVector = moveVector + camera.CFrame.RightVector
                        end
                        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                            moveVector = moveVector + Vector3.new(0, 1, 0)
                        end
                        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                            moveVector = moveVector - Vector3.new(0, 1, 0)
                        end
                        
                        bodyVelocity.Velocity = moveVector * CONFIG.flySpeed
                        bodyGyro.CFrame = camera.CFrame
                        wait()
                    end
                end)
            end
        else
            notify("Fly is already enabled", "warning")
        end
        return
    end
    
    if command == "unfly" then
        STATE.flying = false
        for _, obj in pairs(DATA.flyObjects) do
            if obj and obj.Parent then
                obj:Destroy()
            end
        end
        DATA.flyObjects = {}
        notify("Fly disabled", "success")
        return
    end
    
    if command == "noclip" then
        STATE.noclip = true
        notify("Noclip enabled", "success")
        
        spawn(function()
            while STATE.noclip do
                if player.Character then
                    for _, part in pairs(player.Character:GetDescendants()) do
                        if part:IsA("BasePart") and part.CanCollide then
                            part.CanCollide = false
                        end
                    end
                end
                wait(0.1)
            end
        end)
        return
    end
    
    if command == "clip" then
        STATE.noclip = false
        notify("Noclip disabled", "success")
        return
    end
    
    -- Character Commands
    if command == "speed" or command == "ws" or command == "walkspeed" then
        local speed = tonumber(args[2]) or 16
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = speed
            CONFIG.walkSpeed = speed
            notify("Walk speed set to " .. speed, "success")
        end
        return
    end
    
    if command == "jumppower" or command == "jp" then
        local power = tonumber(args[2]) or 50
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.JumpPower = power
            CONFIG.jumpPower = power
            notify("Jump power set to " .. power, "success")
        end
        return
    end
    
    if command == "reset" then
        load:FireServer()
        notify("Character reset", "success")
        return
    end
    
    -- Farm Commands
    if command == "ff" or command == "fastfarm" then
        STATE.fastfarm = not STATE.fastfarm
        notify("Fast farm " .. (STATE.fastfarm and "enabled" or "disabled"), STATE.fastfarm and "success" or "info")
        return
    end
    
    if command == "sf" or command == "slowfarm" then
        STATE.slowfarm = not STATE.slowfarm
        notify("Slow farm " .. (STATE.slowfarm and "enabled" or "disabled"), STATE.slowfarm and "success" or "info")
        return
    end
    
    if command == "godmode" then
        STATE.god = not STATE.god
        notify("God mode " .. (STATE.god and "enabled" or "disabled"), STATE.god and "success" or "info")
        return
    end
    
    if command == "kaura" or command == "killaura" then
        STATE.kaura = not STATE.kaura
        notify("Kill aura " .. (STATE.kaura and "enabled" or "disabled"), STATE.kaura and "success" or "info")
        return
    end
    
    -- Visual Commands
    if command == "esp" then
        STATE.esp = not STATE.esp
        notify("ESP " .. (STATE.esp and "enabled" or "disabled"), STATE.esp and "success" or "info")
        return
    end
    
    -- Utility Commands
    if command == "rejoin" then
        notify("Rejoining server...", "info")
        wait(1)
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
        return
    end
    
    if command == "cmds" then
        notify("Check the Commands tab for all available commands", "info")
        return
    end
    
    notify("Unknown command: " .. command, "error")
end

-- Modern UI Creation
local function createModernUI()
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SwordSimGUI"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- Try to parent to CoreGui for better security
    local success = pcall(function()
        screenGui.Parent = CoreGui
    end)
    if not success then
        screenGui.Parent = player:WaitForChild("PlayerGui")
    end
    
    -- Main Container
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.Size = UDim2.new(0, 400, 0, 450)
    container.Position = UDim2.new(0.5, -200, 0.5, -225)
    container.BackgroundColor3 = theme.background
    container.BorderSizePixel = 0
    container.Parent = screenGui
    
    local containerCorner = Instance.new("UICorner")
    containerCorner.CornerRadius = UDim.new(0, 12)
    containerCorner.Parent = container
    
    -- Header
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 40)
    header.BackgroundColor3 = theme.secondary
    header.BorderSizePixel = 0
    header.Parent = container
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 12)
    headerCorner.Parent = header
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 12)
    headerFix.Position = UDim2.new(0, 0, 1, -12)
    headerFix.BackgroundColor3 = theme.secondary
    headerFix.BorderSizePixel = 0
    headerFix.Parent = header
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(0.7, -10, 1, 0)
    title.Position = UDim2.new(0, 15, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "Sword Sim GUI v5.1"
    title.TextColor3 = theme.text
    title.TextSize = 16
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Font = Enum.Font.GothamBold
    title.Parent = header
    
    -- Header Buttons
    local buttonContainer = Instance.new("Frame")
    buttonContainer.Size = UDim2.new(0, 80, 1, 0)
    buttonContainer.Position = UDim2.new(1, -90, 0, 0)
    buttonContainer.BackgroundTransparency = 1
    buttonContainer.Parent = header
    
    local buttonLayout = Instance.new("UIListLayout")
    buttonLayout.FillDirection = Enum.FillDirection.Horizontal
    buttonLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    buttonLayout.SortOrder = Enum.SortOrder.LayoutOrder
    buttonLayout.Padding = UDim.new(0, 8)
    buttonLayout.Parent = buttonContainer
    
    -- Minimize Button
    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Name = "MinimizeButton"
    minimizeBtn.Size = UDim2.new(0, 30, 0, 30)
    minimizeBtn.BackgroundColor3 = theme.tertiary
    minimizeBtn.Text = "−"
    minimizeBtn.TextColor3 = theme.text
    minimizeBtn.TextSize = 20
    minimizeBtn.Font = Enum.Font.Gotham
    minimizeBtn.LayoutOrder = 1
    minimizeBtn.Parent = buttonContainer
    
    local minimizeBtnCorner = Instance.new("UICorner")
    minimizeBtnCorner.CornerRadius = UDim.new(0, 6)
    minimizeBtnCorner.Parent = minimizeBtn
    
    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseButton"
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.BackgroundColor3 = theme.danger
    closeBtn.Text = "×"
    closeBtn.TextColor3 = theme.text
    closeBtn.TextSize = 20
    closeBtn.Font = Enum.Font.Gotham
    closeBtn.LayoutOrder = 2
    closeBtn.Parent = buttonContainer
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 6)
    closeBtnCorner.Parent = closeBtn
    
    -- Tab Container
    local tabContainer = Instance.new("Frame")
    tabContainer.Name = "TabContainer"
    tabContainer.Size = UDim2.new(1, -20, 0, 35)
    tabContainer.Position = UDim2.new(0, 10, 0, 50)
    tabContainer.BackgroundTransparency = 1
    tabContainer.Parent = container
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.FillDirection = Enum.FillDirection.Horizontal
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 5)
    tabLayout.Parent = tabContainer
    
    -- Content Container
    local contentContainer = Instance.new("Frame")
    contentContainer.Name = "ContentContainer"
    contentContainer.Size = UDim2.new(1, -20, 1, -105)
    contentContainer.Position = UDim2.new(0, 10, 0, 95)
    contentContainer.BackgroundColor3 = theme.secondary
    contentContainer.BorderSizePixel = 0
    contentContainer.Parent = container
    
    local contentCorner = Instance.new("UICorner")
    contentCorner.CornerRadius = UDim.new(0, 10)
    contentCorner.Parent = contentContainer
    
    -- Status Bar
    local statusBar = Instance.new("Frame")
    statusBar.Name = "StatusBar"
    statusBar.Size = UDim2.new(1, 0, 0, 25)
    statusBar.Position = UDim2.new(0, 0, 1, -25)
    statusBar.BackgroundColor3 = theme.tertiary
    statusBar.BorderSizePixel = 0
    statusBar.Parent = container
    
    local statusCorner = Instance.new("UICorner")
    statusCorner.CornerRadius = UDim.new(0, 12)
    statusCorner.Parent = statusBar
    
    local statusFix = Instance.new("Frame")
    statusFix.Size = UDim2.new(1, 0, 0, 12)
    statusFix.Position = UDim2.new(0, 0, 0, 0)
    statusFix.BackgroundColor3 = theme.tertiary
    statusFix.BorderSizePixel = 0
    statusFix.Parent = statusBar
    
    local statusText = Instance.new("TextLabel")
    statusText.Name = "StatusText"
    statusText.Size = UDim2.new(1, -20, 1, 0)
    statusText.Position = UDim2.new(0, 10, 0, 0)
    statusText.BackgroundTransparency = 1
    statusText.Text = "Ready"
    statusText.TextColor3 = theme.textDim
    statusText.TextSize = 11
    statusText.TextXAlignment = Enum.TextXAlignment.Left
    statusText.Font = Enum.Font.Gotham
    statusText.Parent = statusBar
    
    return {
        screenGui = screenGui,
        container = container,
        header = header,
        tabContainer = tabContainer,
        contentContainer = contentContainer,
        statusBar = statusBar,
        statusText = statusText,
        closeBtn = closeBtn,
        minimizeBtn = minimizeBtn
    }
end

local function createTab(name, parent)
    local tab = Instance.new("TextButton")
    tab.Name = name .. "Tab"
    tab.Size = UDim2.new(0, 80, 1, 0)
    tab.BackgroundColor3 = theme.tertiary
    tab.Text = name
    tab.TextColor3 = theme.text
    tab.TextSize = 12
    tab.Font = Enum.Font.Gotham
    tab.Parent = parent
    
    local tabCorner = Instance.new("UICorner")
    tabCorner.CornerRadius = UDim.new(0, 6)
    tabCorner.Parent = tab
    
    local tabContent = Instance.new("ScrollingFrame")
    tabContent.Name = name .. "Content"
    tabContent.Size = UDim2.new(1, -10, 1, -10)
    tabContent.Position = UDim2.new(0, 5, 0, 5)
    tabContent.BackgroundTransparency = 1
    tabContent.BorderSizePixel = 0
    tabContent.ScrollBarThickness = 3
    tabContent.ScrollBarImageColor3 = theme.accent
    tabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
    tabContent.Visible = false
    tabContent.Parent = UI.contentContainer
    
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Padding = UDim.new(0, 8)
    contentLayout.Parent = tabContent
    
    return tab, tabContent
end

local function createSection(name, parent)
    local section = Instance.new("Frame")
    section.Name = name .. "Section"
    section.Size = UDim2.new(1, 0, 0, 25)
    section.BackgroundColor3 = theme.tertiary
    section.BorderSizePixel = 0
    section.Parent = parent
    
    local sectionCorner = Instance.new("UICorner")
    sectionCorner.CornerRadius = UDim.new(0, 6)
    sectionCorner.Parent = section
    
    local sectionLabel = Instance.new("TextLabel")
    sectionLabel.Size = UDim2.new(1, -20, 1, 0)
    sectionLabel.Position = UDim2.new(0, 10, 0, 0)
    sectionLabel.BackgroundTransparency = 1
    sectionLabel.Text = name:upper()
    sectionLabel.TextColor3 = theme.accent
    sectionLabel.TextSize = 11
    sectionLabel.TextXAlignment = Enum.TextXAlignment.Left
    sectionLabel.Font = Enum.Font.GothamBold
    sectionLabel.Parent = section
    
    return section
end

local function createToggle(name, parent, default, callback)
    local toggleFrame = Instance.new("Frame")
    toggleFrame.Name = name .. "Toggle"
    toggleFrame.Size = UDim2.new(1, 0, 0, 35)
    toggleFrame.BackgroundColor3 = theme.tertiary
    toggleFrame.BorderSizePixel = 0
    toggleFrame.Parent = parent
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 6)
    toggleCorner.Parent = toggleFrame
    
    local toggleLabel = Instance.new("TextLabel")
    toggleLabel.Size = UDim2.new(1, -60, 1, 0)
    toggleLabel.Position = UDim2.new(0, 12, 0, 0)
    toggleLabel.BackgroundTransparency = 1
    toggleLabel.Text = name
    toggleLabel.TextColor3 = theme.text
    toggleLabel.TextSize = 12
    toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
    toggleLabel.Font = Enum.Font.Gotham
    toggleLabel.Parent = toggleFrame
    
    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 40, 0, 20)
    toggleButton.Position = UDim2.new(1, -50, 0.5, -10)
    toggleButton.BackgroundColor3 = default and theme.success or theme.background
    toggleButton.Text = ""
    toggleButton.Parent = toggleFrame
    
    local toggleButtonCorner = Instance.new("UICorner")
    toggleButtonCorner.CornerRadius = UDim.new(0, 10)
    toggleButtonCorner.Parent = toggleButton
    
    local toggleIndicator = Instance.new("Frame")
    toggleIndicator.Size = UDim2.new(0, 16, 0, 16)
    toggleIndicator.Position = default and UDim2.new(1, -18, 0, 2) or UDim2.new(0, 2, 0, 2)
    toggleIndicator.BackgroundColor3 = theme.text
    toggleIndicator.BorderSizePixel = 0
    toggleIndicator.Parent = toggleButton
    
    local indicatorCorner = Instance.new("UICorner")
    indicatorCorner.CornerRadius = UDim.new(0, 8)
    indicatorCorner.Parent = toggleIndicator
    
    local active = default or false
    
    toggleButton.MouseButton1Click:Connect(function()
        active = not active
        
        createTween(toggleButton, {
            BackgroundColor3 = active and theme.success or theme.background
        }):Play()
        
        createTween(toggleIndicator, {
            Position = active and UDim2.new(1, -18, 0, 2) or UDim2.new(0, 2, 0, 2)
        }):Play()
        
        callback(active)
    end)
    
    return toggleFrame, function() return active end, function(val) 
        active = val 
        toggleButton.BackgroundColor3 = active and theme.success or theme.background
        toggleIndicator.Position = active and UDim2.new(1, -18, 0, 2) or UDim2.new(0, 2, 0, 2)
    end
end

local function createButton(name, parent, callback)
    local button = Instance.new("TextButton")
    button.Name = name .. "Button"
    button.Size = UDim2.new(1, 0, 0, 35)
    button.BackgroundColor3 = theme.accent
    button.Text = name
    button.TextColor3 = theme.text
    button.TextSize = 12
    button.Font = Enum.Font.GothamBold
    button.Parent = parent
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = button
    
    button.MouseButton1Click:Connect(callback)
    
    button.MouseEnter:Connect(function()
        createTween(button, {BackgroundColor3 = theme.accent:Lerp(Color3.new(1, 1, 1), 0.1)}):Play()
    end)
    
    button.MouseLeave:Connect(function()
        createTween(button, {BackgroundColor3 = theme.accent}):Play()
    end)
    
    return button
end

local function createCommandBar()
    local commandBar = Instance.new("Frame")
    commandBar.Name = "CommandBar"
    commandBar.Size = UDim2.new(0, 400, 0, 40)
    commandBar.Position = UDim2.new(0.5, -200, 0, -50)
    commandBar.BackgroundColor3 = theme.secondary
    commandBar.BorderSizePixel = 0
    commandBar.Visible = false
    commandBar.Parent = UI.screenGui
    
    local commandCorner = Instance.new("UICorner")
    commandCorner.CornerRadius = UDim.new(0, 8)
    commandCorner.Parent = commandBar
    
    local commandStroke = Instance.new("UIStroke")
    commandStroke.Color = theme.accent
    commandStroke.Thickness = 2
    commandStroke.Parent = commandBar
    
    local commandPrefix = Instance.new("TextLabel")
    commandPrefix.Size = UDim2.new(0, 30, 1, 0)
    commandPrefix.BackgroundTransparency = 1
    commandPrefix.Text = ">"
    commandPrefix.TextColor3 = theme.accent
    commandPrefix.TextSize = 16
    commandPrefix.Font = Enum.Font.GothamBold
    commandPrefix.Parent = commandBar
    
    local commandInput = Instance.new("TextBox")
    commandInput.Name = "CommandInput"
    commandInput.Size = UDim2.new(1, -40, 1, -10)
    commandInput.Position = UDim2.new(0, 35, 0, 5)
    commandInput.BackgroundTransparency = 1
    commandInput.Text = ""
    commandInput.PlaceholderText = "Enter command..."
    commandInput.PlaceholderColor3 = theme.textDim
    commandInput.TextColor3 = theme.text
    commandInput.TextSize = 14
    commandInput.TextXAlignment = Enum.TextXAlignment.Left
    commandInput.Font = Enum.Font.Gotham
    commandInput.ClearTextOnFocus = false
    commandInput.Parent = commandBar
    
    commandInput.Focused:Connect(function()
        STATE.focused = true
    end)
    
    commandInput.FocusLost:Connect(function(enterPressed)
        STATE.focused = false
        
        if enterPressed and commandInput.Text ~= "" then
            table.insert(DATA.commandHistory, commandInput.Text)
            DATA.historyIndex = #DATA.commandHistory + 1
            runCommand(commandInput.Text)
            commandInput.Text = ""
        end
        
        createTween(commandBar, {Position = UDim2.new(0.5, -200, 0, -50)}):Play()
        task.wait(0.3)
        commandBar.Visible = false
    end)
    
    return commandBar, commandInput
end

-- Initialize UI
UI = createModernUI()

-- Create command bar
local commandBar, commandInput = createCommandBar()
UI.commandBar = commandBar
UI.commandInput = commandInput

-- Create tabs
local tabs = {}
local tabContents = {}

local function createTabs()
    local tabNames = {"Main", "Combat", "Movement", "Commands"}
    
    for i, tabName in ipairs(tabNames) do
        local tab, content = createTab(tabName, UI.tabContainer)
        tabs[tabName] = tab
        tabContents[tabName] = content
        
        tab.MouseButton1Click:Connect(function()
            -- Hide all contents
            for _, c in pairs(tabContents) do
                c.Visible = false
            end
            
            -- Update tab colors
            for _, t in pairs(tabs) do
                t.BackgroundColor3 = theme.tertiary
            end
            
            -- Show selected content and highlight tab
            content.Visible = true
            tab.BackgroundColor3 = theme.accent
        end)
    end
    
    -- Select first tab by default
    tabs["Main"].BackgroundColor3 = theme.accent
    tabContents["Main"].Visible = true
end

createTabs()

-- Populate Main Tab
local mainContent = tabContents["Main"]

createSection("Farming", mainContent)
local ffToggle = createToggle("Fast Farm", mainContent, STATE.fastfarm, function(val)
    STATE.fastfarm = val
end)

local sfToggle = createToggle("Slow Farm", mainContent, STATE.slowfarm, function(val)
    STATE.slowfarm = val
end)

local godToggle = createToggle("God Mode", mainContent, STATE.god, function(val)
    STATE.god = val
end)

createSection("Combat", mainContent)
local kauraToggle = createToggle("Kill Aura", mainContent, STATE.kaura, function(val)
    STATE.kaura = val
end)

createSection("Utility", mainContent)
createButton("Reload Character", mainContent, function()
    load:FireServer()
    notify("Character reloaded", "success")
end)

createButton("Rejoin Server", mainContent, function()
    runCommand("rejoin")
end)

-- Populate Combat Tab
local combatContent = tabContents["Combat"]

createSection("Quick Actions", combatContent)
createButton("Kill All", combatContent, function()
    runCommand("kill all")
end)

createButton("Kill Others", combatContent, function()
    runCommand("kill others")
end)

createButton("God All", combatContent, function()
    runCommand("god all")
end)

createButton("God Others", combatContent, function()
    runCommand("god others")
end)

-- Populate Movement Tab
local movementContent = tabContents["Movement"]

createSection("Flight", movementContent)
local flyToggle = createToggle("Fly Mode", movementContent, STATE.flying, function(val)
    if val then
        runCommand("fly")
    else
        runCommand("unfly")
    end
end)

createSection("Character", movementContent)
local noclipToggle = createToggle("Noclip", movementContent, STATE.noclip, function(val)
    if val then
        runCommand("noclip")
    else
        runCommand("clip")
    end
end)

createButton("Reset Character", movementContent, function()
    runCommand("reset")
end)

-- Populate Commands Tab
local commandsContent = tabContents["Commands"]

createSection("All Commands", commandsContent)

local commands = {
    {cmd = "kill [player/all/others]", desc = "Kills target player(s)"},
    {cmd = "god [player/all/others]", desc = "Gods target player(s)"},
    {cmd = "tp [player]", desc = "Teleports to player"},
    {cmd = "bring [player]", desc = "Brings player to you"},
    {cmd = "fly", desc = "Enables fly mode"},
    {cmd = "unfly", desc = "Disables fly mode"},
    {cmd = "noclip", desc = "Toggles noclip"},
    {cmd = "clip", desc = "Disables noclip"},
    {cmd = "speed [number]", desc = "Sets walk speed"},
    {cmd = "jumppower [number]", desc = "Sets jump power"},
    {cmd = "reset", desc = "Resets character"},
    {cmd = "ff", desc = "Toggles fast farm"},
    {cmd = "sf", desc = "Toggles slow farm"},
    {cmd = "godmode", desc = "Toggles god mode"},
    {cmd = "kaura", desc = "Toggles kill aura"},
    {cmd = "esp", desc = "Toggles ESP"},
    {cmd = "rejoin", desc = "Rejoins server"},
    {cmd = "cmds", desc = "Shows all commands"}
}

for _, cmd in pairs(commands) do
    local cmdFrame = Instance.new("Frame")
    cmdFrame.Size = UDim2.new(1, 0, 0, 25)
    cmdFrame.BackgroundColor3 = theme.tertiary
    cmdFrame.BorderSizePixel = 0
    cmdFrame.Parent = commandsContent
    
    local cmdCorner = Instance.new("UICorner")
    cmdCorner.CornerRadius = UDim.new(0, 4)
    cmdCorner.Parent = cmdFrame
    
    local cmdLabel = Instance.new("TextLabel")
    cmdLabel.Size = UDim2.new(0.5, -5, 1, 0)
    cmdLabel.Position = UDim2.new(0, 8, 0, 0)
    cmdLabel.BackgroundTransparency = 1
    cmdLabel.Text = cmd.cmd
    cmdLabel.TextColor3 = theme.accent
    cmdLabel.TextSize = 11
    cmdLabel.TextXAlignment = Enum.TextXAlignment.Left
    cmdLabel.Font = Enum.Font.GothamBold
    cmdLabel.Parent = cmdFrame
    
    local descLabel = Instance.new("TextLabel")
    descLabel.Size = UDim2.new(0.5, -8, 1, 0)
    descLabel.Position = UDim2.new(0.5, 0, 0, 0)
    descLabel.BackgroundTransparency = 1
    descLabel.Text = cmd.desc
    descLabel.TextColor3 = theme.text
    descLabel.TextSize = 11
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.Font = Enum.Font.Gotham
    descLabel.Parent = cmdFrame
end

-- Update canvas sizes
for _, content in pairs(tabContents) do
    local totalHeight = 0
    for _, child in pairs(content:GetChildren()) do
        if child:IsA("GuiObject") then
            totalHeight = totalHeight + child.AbsoluteSize.Y + 8
        end
    end
    content.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
end

-- Header Button Events
UI.closeBtn.MouseButton1Click:Connect(function()
    createTween(UI.container, {Position = UDim2.new(0.5, -200, 0, -500)}, 0.5, Enum.EasingStyle.Back):Play()
    wait(0.5)
    UI.screenGui:Destroy()
    STATE.open = false
end)

UI.minimizeBtn.MouseButton1Click:Connect(function()
    STATE.minimized = not STATE.minimized
    
    if STATE.minimized then
        UI.contentContainer.Visible = false
        UI.tabContainer.Visible = false
        UI.statusBar.Visible = false
        createTween(UI.container, {Size = UDim2.new(0, 400, 0, 40)}):Play()
        UI.minimizeBtn.Text = "+"
    else
        UI.contentContainer.Visible = true
        UI.tabContainer.Visible = true
        UI.statusBar.Visible = true
        createTween(UI.container, {Size = UDim2.new(0, 400, 0, 450)}):Play()
        UI.minimizeBtn.Text = "−"
    end
end)

-- Dragging functionality
local dragging = false
local dragStart = nil
local startPos = nil

UI.header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = UI.container.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        UI.container.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Input Handling
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    -- Command bar
    if input.KeyCode == Enum.KeyCode.Semicolon then
        if STATE.open then
            UI.commandBar.Visible = true
            createTween(UI.commandBar, {Position = UDim2.new(0.5, -200, 0, 80)}):Play()
            task.wait(0.3)
            UI.commandInput:CaptureFocus()
        end
    end
end)

-- Chat Handler
local function setupChatHandler()
    player.Chatted:Connect(function(message)
        if message:sub(1, 1) == ";" then
            runCommand(message:sub(2))
        end
    end)
end

setupChatHandler()

-- Main Loop
local frameCount = 0
RunService.Heartbeat:Connect(function()
    frameCount = frameCount + 1
    
    if not STATE.open or not player.Character then return end
    
    local char = player.Character
    local humanoid = char:FindFirstChild("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then return end
    
    -- Update power tracking
    if player.leaderstats and player.leaderstats:FindFirstChild("Power") then
        DATA.pw = player.leaderstats.Power.Value
        DATA.gain = (DATA.pw - DATA.lpw) * 10
        DATA.lpw = DATA.pw
    end
    
    -- Fast Farm
    if STATE.fastfarm then
        local handle = getSwordHandle()
        if handle and handle:FindFirstChild("up") then
            for i = 1, CONFIG.speed do
                handle.up.RemoteEvent:FireServer()
            end
        end
    end
    
    -- Slow Farm
    if STATE.slowfarm then
        local handle = getSwordHandle()
        if handle and handle:FindFirstChild("up") then
            for i = 1, 3 do
                handle.up.RemoteEvent:FireServer()
            end
        end
    end
    
    -- God Mode
    if STATE.god then
        if char:FindFirstChild("pvp") then
            char.pvp:Destroy()
        end
    end
    
    -- Kill Aura
    if STATE.kaura and frameCount % 10 == 0 then
        local handle = getSwordHandle()
        if handle and handle:FindFirstChild("dmg") then
            for _, target in pairs(workspace:GetChildren()) do
                if target:FindFirstChild("Humanoid") and target:FindFirstChild("HumanoidRootPart") then
                    local distance = (rootPart.Position - target.HumanoidRootPart.Position).Magnitude
                    if distance <= CONFIG.killAuraRange and target.Name ~= player.Name and target.Humanoid.Health > 0 then
                        handle.dmg.RemoteEvent:FireServer(target.Humanoid, player.leaderstats.Power.Value)
                    end
                end
            end
        end
    end
    
    -- Anti-Kick
    if STATE.antiKick and frameCount % 300 == 0 then
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
    
    -- Status Display Update
    if frameCount % 30 == 0 then
        local status = ""
        local parts = {}
        
        if STATE.fastfarm then table.insert(parts, "FF") end
        if STATE.slowfarm then table.insert(parts, "SF") end
        if STATE.god then table.insert(parts, "GOD") end
        if STATE.kaura then table.insert(parts, "KA") end
        if STATE.flying then table.insert(parts, "FLY") end
        if STATE.noclip then table.insert(parts, "NC") end
        
        if #parts > 0 then
            status = table.concat(parts, " | ")
        else
            status = "Ready"
        end
        
        if player.leaderstats and player.leaderstats:FindFirstChild("Power") then
            status = status .. " | PWR: " .. player.leaderstats.Power.Value
        end
        
        UI.statusText.Text = status
    end
end)

-- Character respawn handling
player.CharacterAdded:Connect(function(char)
    wait(1)
    
    -- Restore settings
    if char:FindFirstChild("Humanoid") then
        char.Humanoid.WalkSpeed = CONFIG.walkSpeed
        char.Humanoid.JumpPower = CONFIG.jumpPower
    end
    
    -- Re-enable active features
    if STATE.god and char:FindFirstChild("pvp") then
        char.pvp:Destroy()
    end
    
    if STATE.noclip then
        runCommand("noclip")
    end
end)

-- Startup animation
createTween(UI.container, {Position = UDim2.new(0.5, -200, 0.5, -225)}, 0.5, Enum.EasingStyle.Back):Play()

-- Welcome notification
task.wait(0.5)
notify("Sword Sim GUI v5.1 loaded!", "success")
task.wait(1)
notify("Press ';' to open command bar", "info")

-- Character respawn handling
player.CharacterAdded:Connect(function(char)
    wait(1)
    
    -- Restore settings
    if char:FindFirstChild("Humanoid") then
        char.Humanoid.WalkSpeed = CONFIG.walkSpeed
        char.Humanoid.JumpPower = CONFIG.jumpPower
    end
    
    -- Re-enable active features
    if STATE.god and char:FindFirstChild("pvp") then
        char.pvp:Destroy()
    end
    
    if STATE.noclip then
        runCommand("noclip")
    end
end)

-- Startup animation
createTween(UI.container, {Position = UDim2.new(0.5, -200, 0.5, -225)}, 0.5, Enum.EasingStyle.Back):Play()

-- Welcome notification
task.wait(0.5)
notify("Sword Sim GUI v5.1 loaded!", "success")
task.wait(1)
notify("Press ';' to open command bar", "info")
